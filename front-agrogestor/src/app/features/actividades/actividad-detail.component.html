<!-- src/app/features/actividades/actividad-detail.component.html -->

<div class="min-h-screen flex flex-col bg-gradient-to-b from-secondary/20 via-secondary/40 to-secondary/60">
  <!-- Navbar (idéntico a otras pantallas) -->
  <nav
    class="sticky top-0 z-10 backdrop-blur-lg bg-secondary/80 border-b border-secondary/50
           flex items-center justify-between px-8 py-4 shadow-md"
  >
    <div class="flex items-center space-x-4">
      <a (click)="volver()" 
         class="flex items-center space-x-2 text-white hover:text-white/80 transition cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 19l-7-7 7-7" />
        </svg>
        <span class="font-medium">Volver</span>
      </a>
      <img src="/assets/Agrogestor_sinTexto.png" alt="Logo" class="h-16 w-auto object-contain" />
      <h1 class="text-2xl font-extrabold text-white">Detalle de Actividad</h1>
    </div>
  </nav>

  <main class="flex-1 max-w-3xl mx-auto py-16 px-6">
    <!-- Si sigue cargando, muestro spinner -->
    <ng-container *ngIf="loading; else contenidoBlock">
      <div class="text-center py-12">
        <div class="inline-block animate-pulse text-text-secondary">Cargando actividad...</div>
      </div>
    </ng-container>

    <!-- Una vez cargado: mostramos o bien el error, o el form para editar -->
    <ng-template #contenidoBlock>
      <!-- Si hubo error -->
      <div *ngIf="error" class="text-center text-red-600 mb-6">{{ error }}</div>

      <!-- Si no hay error y sí tenemos `actividad`, mostramos el form -->
      <form *ngIf="!error && actividad" (ngSubmit)="guardarCambios(form)" #form="ngForm" novalidate>
        <div class="bg-white rounded-2xl p-8 shadow-lg space-y-6">
          <!-- Tipo de Actividad -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text-primary mb-2">Tipo de Actividad</label>
            <select
              name="tipo_actividad"
              [(ngModel)]="tipo_actividad"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg
                     focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary transition"
            >
              <option [ngValue]="null" disabled>-- Selecciona Tipo --</option>
              <option value="tratamiento">Tratamiento</option>
              <option value="fertilizacion">Fertilización</option>
              <option value="riego">Riego</option>
              <option value="siembra">Siembra</option>
              <option value="cultural">Cultural</option>
            </select>
            <div *ngIf="form.submitted && !tipo_actividad" class="text-red-600 text-sm mt-1">
              Debes elegir un tipo.
            </div>
          </div>

          <!-- Fecha de Actividad -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text-primary mb-2">Fecha de Actividad</label>
            <input
              type="date"
              name="fecha_actividad"
              [(ngModel)]="fecha_actividad"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg
                     focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary transition"
            />
            <div *ngIf="form.submitted && !fecha_actividad" class="text-red-600 text-sm mt-1">
              Indica la fecha.
            </div>
          </div>

          <!-- Usuario -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text-primary mb-2">Usuario</label>
            <select
              name="usuarioId"
              [(ngModel)]="usuarioId"
              (ngModelChange)="onUserChange()"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg
                     focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary transition"
            >
              <option [ngValue]="null" disabled>-- Selecciona Usuario --</option>
              <option *ngFor="let u of usuarios" [ngValue]="u.id">
                {{ u.nombre }} {{ u.apellidos }}
              </option>
            </select>
            <div *ngIf="form.submitted && !usuarioId" class="text-red-600 text-sm mt-1">
              Debes elegir un usuario.
            </div>
          </div>

          <!-- Parcela -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text-primary mb-2">Parcela</label>
            <select
              name="parcelaId"
              [(ngModel)]="parcelaId"
              (ngModelChange)="onParcelaChange()"
              [disabled]="!usuarioId"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg
                     focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary transition
                     disabled:bg-gray-100"
            >
              <option [ngValue]="null" disabled>-- Selecciona Parcela --</option>
              <option *ngFor="let p of parcelasFiltradas" [ngValue]="p.id">
                {{ p.nombre }} — {{ p.propietario }}
              </option>
            </select>
            <div *ngIf="form.submitted && !parcelaId" class="text-red-600 text-sm mt-1">
              Debes elegir una parcela.
            </div>
          </div>

          <!-- Cultivo -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text-primary mb-2">Cultivo</label>
            <select
              name="cultivoId"
              [(ngModel)]="cultivoId"
              [disabled]="!parcelaId"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg
                     focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary transition
                     disabled:bg-gray-100"
            >
              <option [ngValue]="null" disabled>-- Selecciona Cultivo --</option>
              <option *ngFor="let c of cultivosFiltrados" [ngValue]="c.id">
                {{ c.variedad }} ({{ c.fecha_siembra | date:'mediumDate' }})
              </option>
            </select>
            <div *ngIf="form.submitted && !cultivoId" class="text-red-600 text-sm mt-1">
              Debes elegir un cultivo.
            </div>
          </div>

          <!-- Detalles (JSON) -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-text-primary mb-2">Detalles (JSON)</label>
            <textarea
              name="detalles"
              [(ngModel)]="detalles"
              rows="4"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg
                     focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary transition"
            ></textarea>
          </div>

          <!-- Botones: Guardar / Eliminar / Volver -->
          <div class="flex justify-end space-x-4">
            <button
              type="button"
              (click)="eliminarActividad()"
              class="px-5 py-2 bg-red-600 text-white rounded-lg shadow hover:shadow-xl transition"
            >
              Eliminar
            </button>
            <button
              type="submit"
              [disabled]="loading"
              class="px-5 py-2 bg-primary text-white rounded-lg shadow hover:shadow-xl transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {{ loading ? 'Guardando…' : 'Guardar' }}
            </button>
            <button
              type="button"
              (click)="volver()"
              class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
            >
              Volver
            </button>
          </div>

          <!-- Mensaje de error general -->
          <div *ngIf="error" class="mt-4 text-red-600">{{ error }}</div>
        </div>
      </form>
    </ng-template>
  </main>
</div>
